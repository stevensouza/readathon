<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Report Prototype V2 - Q21 Minutes Integrity Check</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --header-height: 60px;
        }

        body {
            padding: 20px;
            background-color: #f5f5f5;
            font-size: 14px;
        }

        .report-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* ===== STICKY HEADER ===== */
        .report-header {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .report-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-actions {
            display: flex;
            gap: 8px;
        }

        .btn-action {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        /* ===== DESCRIPTION INLINE ===== */
        .report-description {
            padding: 10px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9rem;
            color: #495057;
        }

        .report-description strong {
            color: #212529;
        }

        /* ===== COLLAPSIBLE SECTIONS (COMPACT) ===== */
        .report-section {
            border-bottom: 1px solid #dee2e6;
        }

        .report-section summary {
            padding: 8px 20px;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            font-size: 0.9rem;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .report-section summary::-webkit-details-marker {
            display: none;
        }

        .report-section summary::before {
            content: "â–¶";
            font-size: 0.7rem;
            transition: transform 0.3s;
        }

        .report-section[open] summary::before {
            transform: rotate(90deg);
        }

        .report-section summary:hover {
            background-color: #f8f9fa;
        }

        /* Report Information Section */
        .report-metadata summary {
            background-color: #e9ecef;
        }

        .metadata-body {
            padding: 15px 20px;
            background-color: #f8f9fa;
        }

        .metadata-item {
            margin-bottom: 8px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .metadata-item strong {
            color: #495057;
            min-width: 100px;
            display: inline-block;
        }

        .metadata-item .value {
            color: #6c757d;
        }

        .column-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 6px;
            margin-top: 6px;
        }

        .column-badge {
            background-color: #e7f1ff;
            color: #0056b3;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            display: inline-block;
        }

        /* Analysis Section */
        .report-analysis summary {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .analysis-body {
            padding: 15px 20px;
            background-color: #f0f8ff;
        }

        .analysis-compact {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .analysis-summary-box {
            padding: 10px;
            background-color: #d4edda;
            border-left: 3px solid #28a745;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .analysis-summary-box strong {
            color: #155724;
        }

        .breakdown-compact {
            display: flex;
            gap: 10px;
        }

        .breakdown-card {
            flex: 1;
            padding: 10px;
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .breakdown-card-header {
            font-weight: 600;
            color: #856404;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .breakdown-minutes {
            color: #d39e00;
            font-size: 1rem;
        }

        .breakdown-text {
            color: #856404;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .contributors-mini {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .contributors-mini ul {
            margin: 4px 0 0 16px;
            padding: 0;
        }

        .breakdown-total {
            padding: 10px;
            background-color: #d4edda;
            border: 2px solid #28a745;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            color: #155724;
        }

        .insights-compact {
            padding: 10px;
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .insights-compact ul {
            margin: 4px 0 0 20px;
            padding: 0;
        }

        .insights-compact li {
            color: #856404;
            margin-bottom: 3px;
        }

        /* ===== FLOATING ANALYSIS BUTTON ===== */
        .floating-analysis-btn {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .floating-analysis-btn:hover {
            box-shadow: 0 6px 16px rgba(0,0,0,0.4);
            transform: translateY(-50%) scale(1.05);
        }

        /* ===== RESULTS SECTION ===== */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: #343a40;
            color: white;
            font-weight: 600;
        }

        /* ===== TABLE WITH STICKY HEADER ===== */
        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        .results-table {
            margin-bottom: 0;
            font-size: 0.85rem;
        }

        .results-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #495057;
            color: white;
        }

        .results-table thead th {
            font-weight: 600;
            padding: 10px 8px;
            border: none;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .results-table thead th:hover {
            background-color: #5a6268;
        }

        .results-table thead th .sort-icon {
            font-size: 0.7rem;
            margin-left: 4px;
            opacity: 0.5;
        }

        .results-table thead th.sorted .sort-icon {
            opacity: 1;
        }

        /* Tooltip for column descriptions */
        .results-table thead th .tooltip-icon {
            font-size: 0.7rem;
            margin-left: 4px;
            color: #adb5bd;
            cursor: help;
        }

        .results-table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .results-table tbody tr:hover {
            background-color: #e9ecef;
        }

        .results-table tbody td {
            padding: 8px;
            vertical-align: middle;
        }

        .issue-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-cap-only {
            background-color: #fff3cd;
            color: #856404;
        }

        .badge-mismatch {
            background-color: #f8d7da;
            color: #721c24;
        }

        .badge-both {
            background-color: #e7d6ff;
            color: #5a1a8a;
        }

        .difference-positive {
            color: #dc3545;
            font-weight: 600;
        }

        .difference-negative {
            color: #007bff;
            font-weight: 600;
        }

        /* ===== MODAL ===== */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1040;
            display: none;
        }

        .modal-backdrop.show {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal.show {
            display: block;
        }

        .modal-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h5 {
            margin: 0;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }

        .modal-body {
            padding: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .report-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .report-actions {
                width: 100%;
                flex-direction: column;
            }

            .btn-action {
                width: 100%;
                justify-content: center;
            }

            .floating-analysis-btn {
                right: 10px;
                font-size: 0.8rem;
                padding: 10px 12px;
            }

            .breakdown-compact {
                flex-direction: column;
            }

            .table-wrapper {
                max-height: 400px;
            }
        }

        /* Toast notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div class="report-container">
        <!-- STICKY HEADER -->
        <div class="report-header">
            <h1 class="report-title">
                <i class="fas fa-chart-line"></i> Q21: Minutes Integrity Check
            </h1>
            <div class="report-actions">
                <button class="btn btn-light btn-sm btn-action" onclick="copyToClipboard()">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
                <button class="btn btn-success btn-sm btn-action" onclick="exportCSV()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>

        <!-- INLINE DESCRIPTION -->
        <div class="report-description">
            <strong>Description:</strong> Verify that the sum of daily minutes from Daily_Logs matches the cumulative minutes stored in Reader_Cumulative. This report identifies discrepancies and their root causes.
        </div>

        <!-- REPORT INFORMATION (Collapsed, Compact) -->
        <details class="report-section report-metadata">
            <summary>
                <i class="fas fa-info-circle"></i> Report Information
            </summary>
            <div class="metadata-body">
                <div class="metadata-item">
                    <strong>Source:</strong>
                    <span class="value">Daily_Logs, Reader_Cumulative (primary) â€¢ Roster (reference)</span>
                </div>
                <div class="metadata-item">
                    <strong>Note:</strong>
                    <span class="value">Compares SUM(Daily_Logs.minutes_read) vs Reader_Cumulative.cumulative_minutes for each student</span>
                </div>
                <div class="metadata-item">
                    <strong>Sort:</strong>
                    <span class="value">ABS(difference) DESC, student_name ASC (largest discrepancies first)</span>
                </div>
                <div class="metadata-item">
                    <strong>Columns:</strong>
                    <div class="column-list">
                        <span class="column-badge">student_name</span>
                        <span class="column-badge">team_name</span>
                        <span class="column-badge">class_name</span>
                        <span class="column-badge">daily_minutes_sum</span>
                        <span class="column-badge">cumulative_minutes</span>
                        <span class="column-badge">difference</span>
                        <span class="column-badge">cap_exceeded</span>
                        <span class="column-badge">issue_type</span>
                    </div>
                    <small class="text-muted">Hover over column headers in table for descriptions</small>
                </div>
            </div>
        </details>

        <!-- ANALYSIS (Collapsed, Compact) -->
        <details class="report-section report-analysis">
            <summary>
                <i class="fas fa-chart-pie"></i> Analysis
            </summary>
            <div class="analysis-body">
                <div class="analysis-compact">
                    <!-- Summary -->
                    <div class="analysis-summary-box">
                        <strong>Summary:</strong> The 752-minute discrepancy between Daily_Logs (61,946) and Reader_Cumulative (62,698) consists of two issues.
                    </div>

                    <!-- Breakdown -->
                    <div class="breakdown-compact">
                        <div class="breakdown-card">
                            <div class="breakdown-card-header">
                                <span>1. 120-Min Cap</span>
                                <span class="breakdown-minutes">242 min</span>
                            </div>
                            <div class="breakdown-text">
                                9 students exceeded 120 min/day. Daily_Logs caps at 120/day, Reader_Cumulative doesn't.
                            </div>
                            <div class="contributors-mini">
                                <strong>Top:</strong>
                                <ul>
                                    <li>Noah S.C.: 75 min</li>
                                    <li>Hansen K.: 52 min</li>
                                    <li>Alice S.: 45 min</li>
                                </ul>
                            </div>
                        </div>

                        <div class="breakdown-card">
                            <div class="breakdown-card-header">
                                <span>2. Out-of-Range Dates</span>
                                <span class="breakdown-minutes">510 min</span>
                            </div>
                            <div class="breakdown-text">
                                11 students have reading outside contest dates (10/10-10/15). Reader_Cumulative includes all dates.
                            </div>
                            <div class="contributors-mini">
                                <strong>Top:</strong>
                                <ul>
                                    <li>Fenton M.: +120 min</li>
                                    <li>Hunt N.: +120 min</li>
                                    <li>Loretta M.: +120 min</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="breakdown-total">
                        <i class="fas fa-equals"></i> TOTAL: 242 + 510 = 752 minutes âœ“
                    </div>

                    <!-- Insights -->
                    <div class="insights-compact">
                        <strong><i class="fas fa-lightbulb"></i> Recommendations:</strong>
                        <ul>
                            <li>Verify contest date range matches data downloads</li>
                            <li>Ensure parents only enter reading for sanctioned dates</li>
                            <li>Consider applying 120-min cap to Reader_Cumulative</li>
                        </ul>
                    </div>
                </div>
            </div>
        </details>

        <!-- RESULTS HEADER -->
        <div class="results-header">
            <span>
                <i class="fas fa-table"></i> Results: 20 students with discrepancies
            </span>
        </div>

        <!-- RESULTS TABLE (Sticky Header, Sortable, Tooltips) -->
        <div class="table-wrapper">
            <table class="table results-table" id="resultsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)" data-tooltip="Student's full name from Roster table">
                            Student Name
                            <i class="bi bi-info-circle tooltip-icon" title="Student's full name from Roster table"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                        <th onclick="sortTable(1)" data-tooltip="Student's team assignment (Kitsko or Staub)">
                            Team
                            <i class="bi bi-info-circle tooltip-icon" title="Student's team assignment"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                        <th onclick="sortTable(2)" data-tooltip="Student's class/teacher name">
                            Class
                            <i class="bi bi-info-circle tooltip-icon" title="Student's class/teacher"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                        <th onclick="sortTable(3)" data-tooltip="Total minutes from Daily_Logs (uncapped actual values)">
                            Daily Minutes Sum
                            <i class="bi bi-info-circle tooltip-icon" title="Total from Daily_Logs (uncapped)"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                        <th onclick="sortTable(4)" data-tooltip="Total minutes from Reader_Cumulative download file">
                            Cumulative Minutes
                            <i class="bi bi-info-circle tooltip-icon" title="Total from Reader_Cumulative"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                        <th onclick="sortTable(5)" data-tooltip="Cumulative minus Daily (positive = Cumulative higher, negative = Daily higher)">
                            Difference
                            <i class="bi bi-info-circle tooltip-icon" title="Cumulative - Daily"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                        <th onclick="sortTable(6)" data-tooltip="Minutes lost due to 120-minute daily cap (0 if student never exceeded cap)">
                            Cap Exceeded
                            <i class="bi bi-info-circle tooltip-icon" title="Minutes over 120/day cap"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                        <th onclick="sortTable(7)" data-tooltip="CAP_ONLY: Exceeded cap | OUT_OF_RANGE: Reading outside contest dates | BOTH: Both issues">
                            Issue Type
                            <i class="bi bi-info-circle tooltip-icon" title="Type of discrepancy"></i>
                            <i class="bi bi-chevron-expand sort-icon"></i>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr data-daily="720" data-cumulative="840" data-diff="120" data-cap="0">
                        <td>Fenton Harper</td>
                        <td>Kitsko</td>
                        <td>Rice</td>
                        <td>720</td>
                        <td>840</td>
                        <td class="difference-positive">+120</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="120" data-cumulative="240" data-diff="120" data-cap="0">
                        <td>Alex Terry</td>
                        <td>Staub</td>
                        <td>Richards</td>
                        <td>120</td>
                        <td>240</td>
                        <td class="difference-positive">+120</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="720" data-cumulative="840" data-diff="120" data-cap="0">
                        <td>Loretta Harper</td>
                        <td>Kitsko</td>
                        <td>Price</td>
                        <td>720</td>
                        <td>840</td>
                        <td class="difference-positive">+120</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="150" data-cumulative="240" data-diff="90" data-cap="0">
                        <td>Asra Henry</td>
                        <td>Kitsko</td>
                        <td>Reed</td>
                        <td>150</td>
                        <td>240</td>
                        <td class="difference-positive">+90</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="655" data-cumulative="330" data-diff="-325" data-cap="75">
                        <td>Noah Saldivar Hughes</td>
                        <td>Staub</td>
                        <td>Hansen</td>
                        <td>655</td>
                        <td>330</td>
                        <td class="difference-negative">-325</td>
                        <td>75</td>
                        <td><span class="issue-badge badge-both">BOTH</span></td>
                    </tr>
                    <tr data-daily="462" data-cumulative="462" data-diff="0" data-cap="52">
                        <td>Hansen Lawrence</td>
                        <td>Kitsko</td>
                        <td>Richardson</td>
                        <td>462</td>
                        <td>462</td>
                        <td>0</td>
                        <td>52</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="525" data-cumulative="525" data-diff="0" data-cap="45">
                        <td>Alice Knight</td>
                        <td>Staub</td>
                        <td>Pierce</td>
                        <td>525</td>
                        <td>525</td>
                        <td>0</td>
                        <td>45</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="165" data-cumulative="225" data-diff="60" data-cap="0">
                        <td>Layla Lawrence</td>
                        <td>Kitsko</td>
                        <td>Spencer AM</td>
                        <td>165</td>
                        <td>225</td>
                        <td class="difference-positive">+60</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="100" data-cumulative="140" data-diff="40" data-cap="0">
                        <td>Chloe Hunter</td>
                        <td>Staub</td>
                        <td>Stone</td>
                        <td>100</td>
                        <td>140</td>
                        <td class="difference-positive">+40</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="435" data-cumulative="435" data-diff="0" data-cap="30">
                        <td>Peter Holmes</td>
                        <td>Kitsko</td>
                        <td>Porter</td>
                        <td>435</td>
                        <td>435</td>
                        <td>0</td>
                        <td>30</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="196" data-cumulative="221" data-diff="25" data-cap="0">
                        <td>Matthew Lawrence</td>
                        <td>Kitsko</td>
                        <td>Rice</td>
                        <td>196</td>
                        <td>221</td>
                        <td class="difference-positive">+25</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="95" data-cumulative="110" data-diff="15" data-cap="0">
                        <td>Madelyn Morgan</td>
                        <td>Staub</td>
                        <td>Brown PM</td>
                        <td>95</td>
                        <td>110</td>
                        <td class="difference-positive">+15</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="220" data-cumulative="220" data-diff="0" data-cap="10">
                        <td>Friedrich Olson</td>
                        <td>Kitsko</td>
                        <td>Peters</td>
                        <td>220</td>
                        <td>220</td>
                        <td>0</td>
                        <td>10</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="190" data-cumulative="190" data-diff="0" data-cap="10">
                        <td>Wes Lane</td>
                        <td>Staub</td>
                        <td>Powell</td>
                        <td>190</td>
                        <td>190</td>
                        <td>0</td>
                        <td>10</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="419" data-cumulative="419" data-diff="0" data-cap="8">
                        <td>Abigail Hill</td>
                        <td>Kitsko</td>
                        <td>Price</td>
                        <td>419</td>
                        <td>419</td>
                        <td>0</td>
                        <td>8</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="318" data-cumulative="318" data-diff="0" data-cap="7">
                        <td>Aloisia Howard</td>
                        <td>Kitsko</td>
                        <td>Peters</td>
                        <td>318</td>
                        <td>318</td>
                        <td>0</td>
                        <td>7</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="260" data-cumulative="260" data-diff="0" data-cap="5">
                        <td>Luna Murray</td>
                        <td>Staub</td>
                        <td>Rose</td>
                        <td>260</td>
                        <td>260</td>
                        <td>0</td>
                        <td>5</td>
                        <td><span class="issue-badge badge-cap-only">CAP_ONLY</span></td>
                    </tr>
                    <tr data-daily="245" data-cumulative="215" data-diff="-30" data-cap="0">
                        <td>Brynn Myers</td>
                        <td>Staub</td>
                        <td>Hansen</td>
                        <td>245</td>
                        <td>215</td>
                        <td class="difference-negative">-30</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="175" data-cumulative="145" data-diff="-30" data-cap="0">
                        <td>Henry Kennedy</td>
                        <td>Kitsko</td>
                        <td>Rice</td>
                        <td>175</td>
                        <td>145</td>
                        <td class="difference-negative">-30</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                    <tr data-daily="100" data-cumulative="80" data-diff="-20" data-cap="0">
                        <td>Margaret Kennedy</td>
                        <td>Staub</td>
                        <td>Powell</td>
                        <td>100</td>
                        <td>80</td>
                        <td class="difference-negative">-20</td>
                        <td>0</td>
                        <td><span class="issue-badge badge-mismatch">OUT_OF_RANGE</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- FLOATING ANALYSIS BUTTON -->
    <button class="floating-analysis-btn" onclick="openAnalysisModal()">
        ðŸ“Š Analysis
    </button>

    <!-- ANALYSIS MODAL -->
    <div class="modal-backdrop" id="modalBackdrop" onclick="closeAnalysisModal()"></div>
    <div class="modal" id="analysisModal">
        <div class="modal-header">
            <h5><i class="fas fa-chart-line"></i> Analysis - Q21 Minutes Integrity Check</h5>
            <button class="modal-close" onclick="closeAnalysisModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="analysis-summary-box" style="margin-bottom: 15px;">
                <strong>Summary:</strong> The 752-minute discrepancy between Daily_Logs (61,946) and Reader_Cumulative (62,698) consists of two issues.
            </div>

            <div style="display: flex; flex-direction: column; gap: 15px;">
                <div class="breakdown-card">
                    <div class="breakdown-card-header">
                        <span>1. 120-Minute Daily Cap Issue</span>
                        <span class="breakdown-minutes">242 minutes</span>
                    </div>
                    <div class="breakdown-text">
                        9 students exceeded 120 minutes on specific days. Daily_Logs caps at 120/day when totaling, but Reader_Cumulative contains uncapped values.
                    </div>
                    <div class="contributors-mini">
                        <strong>Top Contributors:</strong>
                        <ul>
                            <li>Noah Saldivar Hughes: 75 minutes</li>
                            <li>Hansen Lawrence: 52 minutes</li>
                            <li>Alice Knight: 45 minutes</li>
                        </ul>
                    </div>
                </div>

                <div class="breakdown-card">
                    <div class="breakdown-card-header">
                        <span>2. Out-of-Range Reading Dates</span>
                        <span class="breakdown-minutes">510 minutes</span>
                    </div>
                    <div class="breakdown-text">
                        11 students have reading entries for dates OUTSIDE the contest period (10/10-10/15).
                        Parents may have entered data before contest start or after the last data download.
                        Reader_Cumulative includes all dates, but Daily_Logs only contains sanctioned contest dates.
                    </div>
                    <div class="contributors-mini">
                        <strong>Top Contributors:</strong>
                        <ul>
                            <li>Fenton Harper: +120 minutes</li>
                            <li>Alex Terry: +120 minutes</li>
                            <li>Loretta Harper: +120 minutes</li>
                        </ul>
                    </div>
                </div>

                <div class="breakdown-total">
                    <i class="fas fa-equals"></i> TOTAL DISCREPANCY: 242 + 510 = 752 minutes âœ“
                </div>

                <div class="insights-compact">
                    <strong><i class="fas fa-lightbulb"></i> Recommendations:</strong>
                    <ul>
                        <li>Verify contest date range (10/10-10/15) matches data downloads</li>
                        <li>Ensure parents only enter reading for sanctioned contest dates</li>
                        <li>Consider applying 120-minute daily cap to Reader_Cumulative for consistency</li>
                        <li>Review students with large negative differences (Daily > Cumulative)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Initialize Bootstrap tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Copy to Clipboard
        function copyToClipboard() {
            const table = document.querySelector('.results-table');
            let text = 'Student Name\tTeam\tClass\tDaily Minutes Sum\tCumulative Minutes\tDifference\tCap Exceeded\tIssue Type\n';

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => cell.textContent.trim()).join('\t');
                text += rowData + '\n';
            });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Success!', 'Table data copied to clipboard', 'success');
            }).catch(err => {
                showToast('Error', 'Failed to copy to clipboard', 'danger');
            });
        }

        // Export CSV
        function exportCSV() {
            const table = document.querySelector('.results-table');
            let csv = 'Student Name,Team,Class,Daily Minutes Sum,Cumulative Minutes,Difference,Cap Exceeded,Issue Type\n';

            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => {
                    let text = cell.textContent.trim();
                    if (text.includes(',') || text.includes('"')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    return text;
                }).join(',');
                csv += rowData + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'q21_minutes_integrity_check_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            showToast('Success!', 'Report exported as CSV', 'success');
        }

        // Table Sorting
        let sortDirection = {};
        function sortTable(columnIndex) {
            const table = document.getElementById('resultsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Toggle sort direction
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            const ascending = sortDirection[columnIndex];

            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();

                // Handle numeric columns
                if (columnIndex >= 3 && columnIndex <= 6) {
                    aVal = parseFloat(aVal.replace(/[^0-9.-]/g, '')) || 0;
                    bVal = parseFloat(bVal.replace(/[^0-9.-]/g, '')) || 0;
                }

                if (aVal < bVal) return ascending ? -1 : 1;
                if (aVal > bVal) return ascending ? 1 : -1;
                return 0;
            });

            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));

            // Update sort icons
            table.querySelectorAll('thead th').forEach((th, idx) => {
                const icon = th.querySelector('.sort-icon');
                if (idx === columnIndex) {
                    th.classList.add('sorted');
                    icon.className = ascending ? 'bi bi-chevron-up sort-icon' : 'bi bi-chevron-down sort-icon';
                } else {
                    th.classList.remove('sorted');
                    icon.className = 'bi bi-chevron-expand sort-icon';
                }
            });
        }

        // Analysis Modal
        function openAnalysisModal() {
            document.getElementById('analysisModal').classList.add('show');
            document.getElementById('modalBackdrop').classList.add('show');
        }

        function closeAnalysisModal() {
            document.getElementById('analysisModal').classList.remove('show');
            document.getElementById('modalBackdrop').classList.remove('show');
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAnalysisModal();
            }
        });

        // Toast notification
        function showToast(title, message, type) {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();

            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>
