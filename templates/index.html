{% extends "base.html" %}

{% block title %}Dashboard - Read-a-Thon System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-house-door"></i> Read-a-Thon Dashboard
        </h1>
    </div>
</div>

<!-- Verification Boxes (for comparison with online program) -->
<div class="row g-3 mb-4">
    <!-- Box 1: Total Donations (Green) -->
    <div class="col-lg col-md-6 col-sm-6">
        <div class="card verification-box verification-box-green h-100">
            <div class="card-body text-center">
                <h5 class="verification-title">Total Raised (Donations):</h5>
                <h1 class="verification-value">${{ "{:,.0f}".format(verification_stats.total_donations) if verification_stats else "0" }}</h1>
                <p class="verification-subtitle mb-0">
                    Students with donations: {{ verification_stats.donor_count if verification_stats else 0 }}
                </p>
                <p style="font-size: 0.65rem; margin: 4px 0; opacity: 0.8;">
                    <strong>Source:</strong> Reader_Cumulative table
                </p>
                <p class="verification-timestamp">
                    {% if verification_stats and verification_stats.donations_last_updated %}
                        Last Updated: {{ verification_stats.donations_last_updated }}
                    {% else %}
                        No data uploaded yet
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Box 2: Total Minutes Read (Blue) -->
    <div class="col-lg col-md-6 col-sm-6">
        <div class="card verification-box verification-box-blue h-100">
            <div class="card-body text-center">
                <h5 class="verification-title">Total Minutes Read:</h5>
                <div style="font-size: 0.7rem; margin-bottom: 8px;">
                    <div style="margin-bottom: 4px;">
                        <strong>Daily_Logs:</strong> {{ "{:,}".format(verification_stats.total_minutes) if verification_stats else "0" }}
                    </div>
                    <div style="margin-bottom: 4px;">
                        <strong>Reader_Cumulative:</strong> {{ "{:,}".format(verification_stats.total_minutes_cumulative) if verification_stats else "0" }}
                    </div>
                    <div style="padding-top: 4px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <strong>Difference:</strong>
                        {% if verification_stats and verification_stats.total_minutes_difference != 0 %}
                            <span style="color: #ffc107; font-weight: bold;">{{ "{:,}".format(verification_stats.total_minutes_difference) }}</span>
                        {% else %}
                            {{ "{:,}".format(verification_stats.total_minutes_difference if verification_stats else 0) }}
                        {% endif %}
                    </div>
                </div>
                <p class="verification-subtitle mb-0">
                    Readers with minutes: {{ verification_stats.reader_count if verification_stats else 0 }}
                </p>
                <p style="font-size: 0.65rem; margin: 4px 0; opacity: 0.8;">
                    <strong>Sources:</strong> Daily_Logs (120-minute daily cap), Reader_Cumulative (uncapped)
                </p>
                <p class="verification-timestamp">
                    {% if verification_stats and verification_stats.minutes_last_updated %}
                        Last Updated: {{ verification_stats.minutes_last_updated }}
                    {% else %}
                        No data uploaded yet
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Box 3: Top Readers (Orange) -->
    <div class="col-lg col-md-6 col-sm-6">
        <div class="card verification-box verification-box-orange h-100">
            <div class="card-body text-center">
                <h5 class="verification-title">Top Readers:</h5>
                <div class="verification-detail">
                    <strong>Top Raised:</strong><br>
                    {{ verification_stats.top_fundraiser_name if verification_stats else "N/A" }}
                    <span class="verification-amount">${{ "{:,.0f}".format(verification_stats.top_fundraiser_amount) if verification_stats else "0" }}</span>
                </div>
                <hr class="my-2">
                <div class="verification-detail">
                    <strong>Top Minutes:</strong><br>
                    {{ verification_stats.top_reader_name if verification_stats else "N/A" }}
                    <span class="verification-amount">{{ "{:,}".format(verification_stats.top_reader_minutes) if verification_stats else "0" }}</span>
                </div>
                <p style="font-size: 0.65rem; margin: 4px 0; opacity: 0.8;">
                    <strong>Sources:</strong> Reader_Cumulative (donations), Daily_Logs (minutes)
                </p>
                <p class="verification-timestamp">
                    {% if verification_stats and (verification_stats.donations_last_updated or verification_stats.minutes_last_updated) %}
                        Last Updated: {{ verification_stats.minutes_last_updated or verification_stats.donations_last_updated }}
                    {% else %}
                        No data uploaded yet
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Box 4: Top Classes (Purple) -->
    <div class="col-lg col-md-6 col-sm-6">
        <div class="card verification-box verification-box-purple h-100">
            <div class="card-body text-center">
                <h5 class="verification-title">Top Classes:</h5>
                <div class="verification-detail">
                    <strong>Top Raised:</strong><br>
                    {{ verification_stats.top_fundraising_class if verification_stats else "N/A" }}
                    <span class="verification-amount">${{ "{:,.0f}".format(verification_stats.top_fundraising_class_amount) if verification_stats else "0" }}</span>
                </div>
                <hr class="my-2">
                <div class="verification-detail">
                    <strong>Top Minutes:</strong><br>
                    {{ verification_stats.top_reading_class if verification_stats else "N/A" }}
                    <span class="verification-amount">{{ "{:,}".format(verification_stats.top_reading_class_minutes) if verification_stats else "0" }}</span>
                </div>
                <p style="font-size: 0.65rem; margin: 4px 0; opacity: 0.8;">
                    <strong>Sources:</strong> Roster + Reader_Cumulative (donations), Roster + Daily_Logs (minutes)
                </p>
                <p class="verification-timestamp">
                    {% if verification_stats and (verification_stats.donations_last_updated or verification_stats.minutes_last_updated) %}
                        Last Updated: {{ verification_stats.minutes_last_updated or verification_stats.donations_last_updated }}
                    {% else %}
                        No data uploaded yet
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Box 5: Data Integrity Checks -->
    <div class="col-lg col-md-6 col-sm-6">
        <div class="card verification-box {% if verification_stats and verification_stats.all_integrity_checks_pass %}verification-box-success{% else %}verification-box-red{% endif %} h-100">
            <div class="card-body text-center">
                <h5 class="verification-title">Data Integrity:</h5>
                {% if verification_stats and verification_stats.all_integrity_checks_pass %}
                    <div class="integrity-icon"><i class="bi bi-check-circle-fill"></i></div>
                    <p class="verification-subtitle mb-0"><strong>ALL CHECKS PASS</strong></p>
                {% else %}
                    <div class="integrity-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                    <p class="verification-subtitle mb-0"><strong>ISSUES FOUND</strong></p>
                {% endif %}
                <div style="background-color: rgba(255, 255, 255, 0.15); padding: 6px; border-radius: 5px; margin-top: 8px; font-size: 0.75rem; text-align: left;">
                    <div style="margin-bottom: 3px;">
                        <strong style="font-size: 0.7rem;">Minutes Match:</strong>
                        {% if verification_stats.integrity_match %}
                            <span style="background-color: rgba(255, 255, 255, 0.9); color: #28a745; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.7rem;">✓</span>
                        {% else %}
                            <span style="background-color: rgba(255, 255, 255, 0.9); color: #dc3545; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.7rem;">✗</span>
                        {% endif %}
                    </div>
                    <div style="margin-bottom: 3px;">
                        <strong style="font-size: 0.7rem;">Names Synced:</strong>
                        {% if verification_stats.name_sync_pass %}
                            <span style="background-color: rgba(255, 255, 255, 0.9); color: #28a745; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.7rem;">✓</span>
                        {% else %}
                            <span style="background-color: rgba(255, 255, 255, 0.9); color: #dc3545; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.7rem;">✗</span>
                        {% endif %}
                    </div>
                    <div>
                        <strong style="font-size: 0.7rem;">In Roster:</strong>
                        {% if verification_stats.roster_integrity_pass %}
                            <span style="background-color: rgba(255, 255, 255, 0.9); color: #28a745; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.7rem;">✓</span>
                        {% else %}
                            <span style="background-color: rgba(255, 255, 255, 0.9); color: #dc3545; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.7rem;">✗</span>
                        {% endif %}
                    </div>
                </div>
                <p class="verification-timestamp" style="margin-top: 6px;">
                    <a href="/reports" style="color: rgba(255, 255, 255, 0.7); text-decoration: underline; font-size: 0.7rem;">View Details</a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Participation Stats Box -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="row text-center align-items-center">
                    <div class="col-md-6">
                        <h4 class="mb-0">
                            <i class="bi bi-people-fill"></i> Students Participating:
                            <strong>{{ verification_stats.participating_students if verification_stats else 0 }} of {{ verification_stats.total_students if verification_stats else 0 }}</strong>
                            <span class="badge bg-light text-dark ms-2" style="font-size: 1.2rem;">{{ verification_stats.participation_pct if verification_stats else 0 }}%</span>
                        </h4>
                        <p style="font-size: 0.7rem; margin-top: 8px; margin-bottom: 0; opacity: 0.9;">
                            <em>Definition: Students who have read at least one day (minutes_read > 0 in Daily_Logs)</em>
                        </p>
                        <p style="font-size: 0.65rem; margin-top: 4px; margin-bottom: 0; opacity: 0.8;">
                            <strong>Sources:</strong> Daily_Logs (participating), Roster (total students)
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h4 class="mb-0">
                            <i class="bi bi-calendar-range"></i> Days of Data:
                            <strong>{{ verification_stats.days_of_data if verification_stats else 0 }}</strong>
                        </h4>
                        <p style="font-size: 0.65rem; margin-top: 8px; margin-bottom: 0; opacity: 0.8;">
                            <strong>Source:</strong> Daily_Logs (distinct log_date count)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Database Stats -->
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title text-muted">Students</h5>
                <h2 class="mb-0">{{ counts.Roster }}</h2>
                <p class="text-muted mb-0" style="font-size: 0.7rem;">Source: Roster table</p>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title text-muted">Classes</h5>
                <h2 class="mb-0">{{ counts.Class_Info }}</h2>
                <p class="text-muted mb-0" style="font-size: 0.7rem;">Source: Class_Info table</p>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title text-muted">Grade Levels</h5>
                <h2 class="mb-0">{{ counts.Grade_Rules }}</h2>
                <p class="text-muted mb-0" style="font-size: 0.7rem;">Source: Grade_Rules table</p>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h5 class="card-title text-muted">Daily Log Entries</h5>
                <h2 class="mb-0">{{ counts.Daily_Logs }}</h2>
                <p class="text-muted mb-0" style="font-size: 0.7rem;">Source: Daily_Logs table</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Quick Actions -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="/upload" class="btn btn-lg btn-outline-primary">
                        <i class="bi bi-upload"></i> Upload Today's Data
                    </a>
                    <a href="/workflows" class="btn btn-lg btn-outline-success">
                        <i class="bi bi-diagram-3"></i> Run Daily Slide Update
                    </a>
                    <a href="/reports" class="btn btn-lg btn-outline-info">
                        <i class="bi bi-graph-up"></i> View All Reports (Queries)
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Dates -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Data Available for Dates</h5>
            </div>
            <div class="card-body">
                {% if dates %}
                <ul class="list-group" id="datesList">
                    {% for date in dates[:10] %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ date }}
                        <div>
                            <span class="badge bg-primary rounded-pill me-2">
                                <i class="bi bi-check-circle"></i>
                            </span>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDay('{{ date }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No daily data uploaded yet.
                    <a href="/upload" class="alert-link">Upload your first day's data</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header {% if environment == 'sample' %}bg-danger{% else %}bg-primary{% endif %} text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Uploads (Last 5)</h5>
            </div>
            <div class="card-body">
                <div id="recentUploadsHome">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
async function loadRecentUploads() {
    try {
        const response = await fetch('/api/upload_history');
        const data = await response.json();

        const uploadsDiv = document.getElementById('recentUploadsHome');

        if (data.success && data.history && data.history.length > 0) {
            const recent = data.history.slice(0, 5);
            const uploadsHTML = `
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Uploaded</th>
                                <th>Files</th>
                                <th>Students</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recent.map(h => `
                                <tr>
                                    <td><strong>${h.log_date}</strong></td>
                                    <td><small>${new Date(h.upload_timestamp).toLocaleString()}</small></td>
                                    <td>
                                        <small>
                                            ${h.minutes_filename ? `📖 ${h.minutes_filename}` : ''}
                                            ${h.donations_filename ? `💰 ${h.donations_filename}` : ''}
                                        </small>
                                    </td>
                                    <td>${h.total_students_affected}</td>
                                    <td><span class="badge ${h.upload_type === 'new' ? 'bg-success' : 'bg-warning'}">${h.upload_type}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <a href="/upload" class="btn btn-sm btn-outline-primary">View Full History</a>
                </div>
            `;
            uploadsDiv.innerHTML = uploadsHTML;
        } else {
            uploadsDiv.innerHTML = '<p class="text-muted text-center py-3">No uploads yet. <a href="/upload">Upload your first day\'s data</a></p>';
        }
    } catch (error) {
        document.getElementById('recentUploadsHome').innerHTML =
            '<p class="text-danger text-center py-3">Error loading upload history</p>';
    }
}

async function deleteDay(logDate) {
    const confirmMsg = `⚠️ DELETE DATA WARNING!\n\n` +
        `You are about to permanently delete ALL data for ${logDate}.\n\n` +
        `This will remove:\n` +
        `- All student minutes and donations for this date\n` +
        `- Upload history records\n\n` +
        `This action CANNOT be undone!\n\n` +
        `Are you ABSOLUTELY SURE you want to delete this date?`;

    if (!confirm(confirmMsg)) {
        return;
    }

    try {
        const response = await fetch(`/api/delete_day/${logDate}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert(`✅ Successfully deleted ${result.deleted_records} records for ${logDate} from ${result.environment.toUpperCase()} environment.`);
            // Reload the page to refresh all data
            location.reload();
        } else {
            alert(`❌ Error: ${result.error}`);
        }
    } catch (error) {
        alert(`❌ Error deleting day: ${error.message}`);
    }
}

// Load recent uploads on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRecentUploads();
});
</script>
{% endblock %}
