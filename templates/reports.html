{% extends "base.html" %}

{% block title %}Reports (Queries) - Read-a-Thon System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-graph-up"></i> Reports (Queries)
        </h1>
    </div>
</div>

<div class="row">
    <!-- Report List -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header card-header-blue">
                <h5 class="mb-0">Available Reports</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for report in reports %}
                <a href="#" class="list-group-item list-group-item-action report-link" data-report-id="{{ report.id }}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ report.name }}</h6>
                        <small class="badge {% if report.type == 'utility' %}bg-secondary{% elif report.type == 'daily' %}bg-info{% elif report.type == 'cumulative' %}bg-success{% elif report.type == 'export' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">{{ report.type }}</small>
                    </div>
                    <small class="text-muted">{{ report.description }}</small>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Report Options -->
        <div class="card mt-3" id="reportOptions" style="display: none;">
            <div class="card-header card-header-blue">
                <h6 class="mb-0">Report Options</h6>
            </div>
            <div class="card-body">
                <!-- Date Selection (for date-specific reports) -->
                <div class="mb-3" id="dateOption">
                    <label for="reportDate" class="form-label">Date</label>
                    <select class="form-select" id="reportDate" onchange="runCurrentReport()">
                        <option value="">All Dates</option>
                        {% for date in dates %}
                        <option value="{{ date }}">{{ date }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Group By (for Q2) -->
                <div class="mb-3" id="groupByOption" style="display: none;">
                    <label for="groupBy" class="form-label">Group By</label>
                    <select class="form-select" id="groupBy" onchange="runCurrentReport()">
                        <option value="class">Class</option>
                        <option value="team">Team</option>
                    </select>
                </div>

                <!-- Sort By (for Q5) -->
                <div class="mb-3" id="sortByOption" style="display: none;">
                    <label for="sortBy" class="form-label">Sort By</label>
                    <select class="form-select" id="sortBy" onchange="runCurrentReport()">
                        <option value="minutes">Total Minutes (Top Readers)</option>
                        <option value="goal">Days Met Goal (Goal Getters)</option>
                        <option value="donations">Total Donations (Top Fundraisers)</option>
                    </select>
                </div>

                <!-- Limit (for Q5) -->
                <div class="mb-3" id="limitOption" style="display: none;">
                    <label for="limitRows" class="form-label">Show Top</label>
                    <select class="form-select" id="limitRows" onchange="runCurrentReport()">
                        <option value="">All Students</option>
                        <option value="10">Top 10</option>
                        <option value="25">Top 25</option>
                        <option value="50">Top 50</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Results -->
    <div class="col-md-8">
        <div id="reportResults">
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select a report from the list to get started</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentReportId = null;

// Report link click handler
document.querySelectorAll('.report-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        currentReportId = this.dataset.reportId;

        // Highlight selected report
        document.querySelectorAll('.report-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        // Show/hide options based on report
        showReportOptions(currentReportId);

        // Show options panel
        document.getElementById('reportOptions').style.display = 'block';

        // Auto-run report immediately
        runCurrentReport();
    });
});

function showReportOptions(reportId) {
    // Hide all options first
    document.getElementById('dateOption').style.display = 'none';
    document.getElementById('groupByOption').style.display = 'none';
    document.getElementById('sortByOption').style.display = 'none';
    document.getElementById('limitOption').style.display = 'none';

    // Show relevant options
    if (reportId === 'q2') {
        document.getElementById('dateOption').style.display = 'block';
        document.getElementById('groupByOption').style.display = 'block';
    } else if (reportId === 'q4' || reportId === 'q7') {
        document.getElementById('dateOption').style.display = 'block';
    } else if (reportId === 'q5') {
        document.getElementById('sortByOption').style.display = 'block';
        document.getElementById('limitOption').style.display = 'block';
    }
}

async function runCurrentReport() {
    if (!currentReportId) return;

    const date = document.getElementById('reportDate').value;
    const groupBy = document.getElementById('groupBy').value;
    const sortBy = document.getElementById('sortBy').value;
    const limit = document.getElementById('limitRows').value;

    let url = `/api/report/${currentReportId}?`;
    if (date) url += `date=${date}&`;
    if (groupBy) url += `group_by=${groupBy}&`;
    if (sortBy) url += `sort_by=${sortBy}&`;
    if (limit) url += `limit=${limit}&`;

    // Show loading
    document.getElementById('reportResults').innerHTML = `
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Generating report...</p>
            </div>
        </div>
    `;

    try {
        const response = await fetch(url);
        const result = await response.json();

        if (result.error) {
            throw new Error(result.error);
        }

        displayReport(result);
    } catch (error) {
        document.getElementById('reportResults').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
            </div>
        `;
    }
}

function displayReport(report) {
    // Build Export/Copy buttons
    const exportUrl = `/api/export/${currentReportId}?date=${document.getElementById('reportDate').value}&group_by=${document.getElementById('groupBy').value}&sort_by=${document.getElementById('sortBy').value}`;

    const headerButtons = `
        <button class="btn btn-sm btn-primary" onclick="copyTableToClipboard('reportTable')">
            <i class="bi bi-clipboard"></i> Copy
        </button>
        <a href="${exportUrl}" class="btn btn-sm btn-primary ms-2" download>
            <i class="bi bi-download"></i> Export
        </a>
    `;

    // Build description + last updated section
    const lastUpdated = report.last_updated || 'Not available';
    const descriptionHtml = `
        <div class="report-description">
            <div><strong>Description:</strong> ${report.description}</div>
            <div class="last-updated">
                <strong>Last Updated:</strong> ${lastUpdated}
            </div>
        </div>
    `;

    // Build Report Information section (metadata)
    let metadataHtml = '';
    if (report.metadata) {
        const sourceTablesHtml = report.metadata.source_tables ?
            `<div class="metadata-item">
                <strong>Source Tables:</strong>
                <span class="value">${report.metadata.source_tables}</span>
            </div>` : '';

        const sortHtml = report.sort ?
            `<div class="metadata-item">
                <strong>Sort Order:</strong>
                <span class="value">${report.sort}</span>
            </div>` : '';

        const noteHtml = report.note ?
            `<div class="metadata-item">
                <strong>Note:</strong>
                <span class="value">${report.note}</span>
            </div>` : '';

        // Build columns subsection
        let columnsHtml = '';
        if (report.metadata.columns && report.columns && report.columns.length > 0) {
            const columnCount = report.columns.length;
            // Use report.columns array to preserve order, convert to uppercase for display
            const columnsBody = report.columns.map(col => {
                const meta = report.metadata.columns[col];
                if (!meta) return ''; // Skip if no metadata
                const displayCol = col.toUpperCase().replace(/_/g, ' ');
                const mapping = meta.source ? `${displayCol} ‚Üê ${meta.source}${meta.formula ? ' ' + meta.formula : ''}` : displayCol;
                return `
                    <div class="column-item">
                        <span class="column-mapping">‚Ä¢ ${mapping}:</span>
                        <span class="column-description">${meta.description || 'No description available'}</span>
                    </div>
                `;
            }).filter(html => html).join('');

            columnsHtml = `
                <details class="nested-subsection">
                    <summary>
                        <i class="bi bi-columns"></i> Columns & Data Sources <span class="text-muted">(${columnCount} columns)</span>
                    </summary>
                    <div class="subsection-body">
                        ${columnsBody}
                        <small class="text-muted" style="margin-top: 8px; display: block;">
                            <i class="bi bi-info-circle"></i> Tip: Hover over column headers in the table below for quick reference
                        </small>
                    </div>
                </details>
            `;
        }

        // Build terms subsection
        let termsHtml = '';
        if (report.metadata.terms && Object.keys(report.metadata.terms).length > 0) {
            const termCount = Object.keys(report.metadata.terms).length;
            const termsBody = Object.entries(report.metadata.terms).map(([term, def]) => {
                const seeAlso = def.see_also ? `<span class="see-also">See also: ${def.see_also.join(', ')}</span>` : '';
                return `
                    <div class="term-item">
                        <span class="term-name">${term}:</span>
                        <span class="term-definition">${def.definition || def}</span>
                        ${seeAlso}
                    </div>
                `;
            }).join('');

            termsHtml = `
                <details class="nested-subsection">
                    <summary>
                        <i class="bi bi-book"></i> Key Terms & Definitions <span class="text-muted">(${termCount} terms)</span>
                    </summary>
                    <div class="subsection-body">
                        ${termsBody}
                    </div>
                </details>
            `;
        }

        metadataHtml = `
            <details class="report-section report-metadata">
                <summary>
                    <i class="bi bi-info-circle"></i> Report Information
                </summary>
                <div class="metadata-body">
                    ${sourceTablesHtml}
                    ${noteHtml}
                    ${sortHtml}
                    ${columnsHtml}
                    ${termsHtml}
                </div>
            </details>
        `;
    }

    // Build Analysis section
    let analysisHtml = '';
    if (report.analysis) {
        const summaryHtml = report.analysis.summary ?
            `<div class="analysis-summary-box">
                <strong>Summary:</strong> ${report.analysis.summary}
            </div>` : '';

        const breakdownHtml = report.analysis.breakdown && report.analysis.breakdown.length > 0 ?
            `<div class="breakdown-compact">
                ${report.analysis.breakdown.map(item => `
                    <div class="breakdown-card">
                        <div class="breakdown-card-header">
                            <span>${item.issue}</span>
                            <span class="breakdown-minutes">${item.minutes || item.amount} ${item.unit || 'min'}</span>
                        </div>
                        <div class="breakdown-text">${item.explanation}</div>
                        ${item.top_contributors ? `
                            <div class="contributors-mini">
                                <strong>Top:</strong>
                                <ul>
                                    ${item.top_contributors.slice(0, 3).map(c =>
                                        `<li>${c.student || c.name}: ${c.amount} ${item.unit || 'min'}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>` : '';

        const totalHtml = report.analysis.metrics && report.analysis.metrics.total_discrepancy !== undefined ?
            `<div class="breakdown-total">
                <i class="bi bi-equals"></i> TOTAL: ${report.analysis.metrics.total_discrepancy} ${report.analysis.metrics.unit || 'minutes'} ‚úì
            </div>` : '';

        const insightsHtml = report.analysis.insights && report.analysis.insights.length > 0 ?
            `<div class="insights-compact">
                <strong><i class="bi bi-lightbulb"></i> Key Findings:</strong>
                <ul>
                    ${report.analysis.insights.map(insight => `<li>${insight}</li>`).join('')}
                </ul>
            </div>` : '';

        analysisHtml = `
            <details class="report-section report-analysis">
                <summary>
                    <i class="bi bi-pie-chart"></i> Analysis
                </summary>
                <div class="analysis-body">
                    <div class="analysis-compact">
                        ${summaryHtml}
                        ${breakdownHtml}
                        ${totalHtml}
                        ${insightsHtml}
                    </div>
                </div>
            </details>
        `;
    }

    // Build Winners alert
    let winnersHtml = '';
    if (report.winners && report.winners.length > 0) {
        winnersHtml = `
            <div class="alert alert-warning">
                <strong><i class="bi bi-trophy-fill"></i> Winner(s):</strong>
                ${report.winners.map(w => w.class_name || w.team_name || w.student_name).join(', ')}
            </div>
        `;
    }

    // Build table
    let tableHtml = '';
    if (report.data && report.data.length > 0) {
        const winnerKeys = report.winners ? new Set(report.winners.map(w =>
            w.class_name || w.team_name || w.student_name
        )) : new Set();

        // Get tooltips from metadata if available
        const getTooltip = (col) => {
            if (report.metadata && report.metadata.columns && report.metadata.columns[col]) {
                return report.metadata.columns[col].description || '';
            }
            return '';
        };

        tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover report-table" id="reportTable">
                    <thead class="table-dark">
                        <tr>
                            ${report.columns.map((col, idx) => {
                                const tooltip = getTooltip(col);
                                const titleAttr = tooltip ? `title="${tooltip.replace(/"/g, '&quot;')}"` : '';
                                return `<th class="sortable-header" onclick="sortTable(${idx})" ${titleAttr}>
                                    ${col.replace(/_/g, ' ').toUpperCase()}
                                    ${tooltip ? '<i class="bi bi-info-circle tooltip-icon"></i>' : ''}
                                    <i class="bi bi-arrow-down-up sort-icon"></i>
                                </th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        ${report.data.map(row => {
                            const isWinner = winnerKeys.has(row.class_name || row.team_name || row.student_name);
                            const rowClass = isWinner ? 'winner-row' : '';
                            return `
                                <tr class="${rowClass}">
                                    ${report.columns.map(col => `<td>${row[col] ?? ''}</td>`).join('')}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        tableHtml = '<div class="alert alert-warning">No data available</div>';
    }

    // Results header
    const resultCount = report.data ? report.data.length : 0;
    const resultsHeader = `
        <div class="results-header" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background-color: #343a40; color: white; font-weight: 600;">
            <span>
                <i class="bi bi-table"></i> Results: ${resultCount} ${resultCount === 1 ? 'row' : 'rows'}
            </span>
        </div>
    `;

    // Render complete report
    document.getElementById('reportResults').innerHTML = `
        <div class="card" style="border-radius: 8px; overflow: hidden;">
            <div class="card-header card-header-blue" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> ${report.title}</h5>
                <div>
                    ${headerButtons}
                </div>
            </div>
            ${descriptionHtml}
            ${metadataHtml}
            ${analysisHtml}
            ${winnersHtml ? '<div class="p-3">' + winnersHtml + '</div>' : ''}
            ${resultsHeader}
            <div class="p-0">
                ${tableHtml}
            </div>
        </div>
    `;

    // TODO - FIX NEEDED: Tooltip initialization causing reports to not display
    // Problem: Bootstrap tooltips failing to initialize, breaking the displayReport() function.
    // This prevents report data from showing when clicking reports from the reports list.
    //
    // Solution (to implement later):
    // 1. Wrap tooltip code in try-catch block to prevent errors from breaking page
    // 2. Dispose existing tooltips before creating new ones (avoid re-initialization errors)
    // 3. Target only report table headers instead of entire page: document.querySelectorAll('#reportTable th[title]')
    // 4. Add console.error() logging for debugging
    //
    // Example fix:
    //   try {
    //       // Dispose existing tooltips first
    //       const existingTooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    //       existingTooltips.forEach(el => {
    //           const tooltip = bootstrap.Tooltip.getInstance(el);
    //           if (tooltip) tooltip.dispose();
    //       });
    //       // Initialize new tooltips only for report table
    //       const tooltipTriggerList = [].slice.call(document.querySelectorAll('#reportTable th[title]'));
    //       tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
    //   } catch (error) {
    //       console.error('Tooltip initialization failed:', error);
    //   }

    // Initialize Bootstrap tooltips (CURRENTLY BROKEN - SEE TODO ABOVE)
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Show/hide floating analysis button
    const floatingBtn = document.getElementById('floatingAnalysisBtn');
    if (report.analysis) {
        if (!floatingBtn) {
            // Create button if it doesn't exist
            const btn = document.createElement('button');
            btn.id = 'floatingAnalysisBtn';
            btn.className = 'floating-analysis-btn';
            btn.innerHTML = 'üìä Analysis';
            btn.onclick = openAnalysisModal;
            document.body.appendChild(btn);

            // Create modal backdrop
            const backdrop = document.createElement('div');
            backdrop.id = 'analysisModalBackdrop';
            backdrop.className = 'analysis-modal-backdrop';
            backdrop.onclick = closeAnalysisModal;
            document.body.appendChild(backdrop);

            // Create modal container
            const modal = document.createElement('div');
            modal.id = 'analysisModal';
            modal.className = 'analysis-modal';
            document.body.appendChild(modal);

            // ESC key handler
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeAnalysisModal();
            });
        }
        document.getElementById('floatingAnalysisBtn').style.display = 'block';

        // Store analysis data for modal
        window.currentAnalysis = report.analysis;
        window.currentReportTitle = report.title;
    } else {
        if (floatingBtn) {
            floatingBtn.style.display = 'none';
        }
    }
}

function openAnalysisModal() {
    const modal = document.getElementById('analysisModal');
    const backdrop = document.getElementById('analysisModalBackdrop');
    const analysis = window.currentAnalysis;

    if (!analysis || !modal || !backdrop) {
        console.error('Modal elements or analysis data not found');
        return;
    }

    // Build modal content
    let modalHTML = `
        <div class="modal-header">
            <h3>üìä ${window.currentReportTitle || 'Report'} - Analysis</h3>
            <button class="modal-close" onclick="closeAnalysisModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="summary-box">
                <strong>Summary:</strong> ${analysis.summary || 'No summary available'}
            </div>
    `;

    if (analysis.breakdown) {
        analysis.breakdown.forEach(item => {
            modalHTML += `
                <div class="breakdown-card">
                    <h4>${item.issue}: ${item.minutes} ${item.unit || 'minutes'}</h4>
                    <p>${item.explanation}</p>
            `;
            if (item.top_contributors) {
                modalHTML += `
                    <p><strong>Top Contributors:</strong></p>
                    <ul>
                        ${item.top_contributors.map(c =>
                            `<li>${c.student}: ${c.amount} ${item.unit || 'min'}</li>`
                        ).join('')}
                    </ul>
                `;
            }
            modalHTML += `</div>`;
        });
    }

    if (analysis.insights && analysis.insights.length > 0) {
        modalHTML += `
            <div class="insights-compact">
                <strong>Insights & Recommendations:</strong>
                <ul>
                    ${analysis.insights.map(insight => `<li>${insight}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    modalHTML += `</div>`;
    modal.innerHTML = modalHTML;

    // Force display with inline styles as backup
    backdrop.style.cssText = 'display: block !important; position: fixed !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; background-color: rgba(0, 0, 0, 0.6) !important; z-index: 9998 !important;';
    modal.style.cssText = 'display: block !important; position: fixed !important; top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important; max-width: 900px !important; width: 90% !important; max-height: 85vh !important; background: white !important; border-radius: 12px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.3) !important; z-index: 9999 !important; overflow: hidden !important;';

    // Also add classes
    backdrop.classList.add('show');
    modal.classList.add('show');
}

function closeAnalysisModal() {
    const modal = document.getElementById('analysisModal');
    const backdrop = document.getElementById('analysisModalBackdrop');
    if (modal) {
        modal.classList.remove('show');
        modal.style.cssText = ''; // Clear inline styles
    }
    if (backdrop) {
        backdrop.classList.remove('show');
        backdrop.style.cssText = ''; // Clear inline styles
    }
}

let sortDirections = {}; // Track sort direction for each column

function sortTable(columnIndex) {
    const table = document.getElementById('reportTable');
    const tbody = document.getElementById('reportTableBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Toggle sort direction
    if (sortDirections[columnIndex] === undefined || sortDirections[columnIndex] === 'desc') {
        sortDirections[columnIndex] = 'asc';
    } else {
        sortDirections[columnIndex] = 'desc';
    }

    const isAscending = sortDirections[columnIndex] === 'asc';

    // Sort rows
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();

        // Try to parse as number (handle $ and , in numbers)
        const aNum = parseFloat(aValue.replace(/[$,%]/g, ''));
        const bNum = parseFloat(bValue.replace(/[$,%]/g, ''));

        // If both are numbers, sort numerically
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? aNum - bNum : bNum - aNum;
        }

        // Otherwise sort as strings
        return isAscending ?
            aValue.localeCompare(bValue) :
            bValue.localeCompare(aValue);
    });

    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));

    // Update header icons
    const headers = table.querySelectorAll('th.sortable-header');
    headers.forEach((header, idx) => {
        const icon = header.querySelector('i.sort-icon');
        if (icon) {
            header.classList.toggle('sorted', idx === columnIndex);
            if (idx === columnIndex) {
                icon.className = isAscending ? 'bi bi-arrow-up sort-icon' : 'bi bi-arrow-down sort-icon';
            } else {
                icon.className = 'bi bi-arrow-down-up sort-icon';
            }
        }
    });
}
</script>

{% endblock %}
