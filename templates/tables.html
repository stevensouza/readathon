{% extends "base.html" %}

{% block title %}Database Tables - Read-a-Thon System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-table"></i> Database Tables
        </h1>
    </div>
</div>

<div class="row">
    <!-- Table List -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header {% if environment == 'sample' %}bg-danger{% else %}bg-primary{% endif %} text-white">
                <h5 class="mb-0">Available Tables</h5>
            </div>
            <div class="list-group list-group-flush">
                {% for table in tables %}
                <a href="#" class="list-group-item list-group-item-action table-link" data-table-id="{{ table.id }}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">{{ table.name }}</h6>
                    </div>
                    <small class="text-muted">{{ table.description }}</small>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Table Results -->
    <div class="col-md-8">
        <div id="tableResults">
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <i class="bi bi-table" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select a table from the list to view its contents</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTableId = null;

// Table link click handler
document.querySelectorAll('.table-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        currentTableId = this.dataset.tableId;

        // Highlight selected table
        document.querySelectorAll('.table-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');

        // Auto-load table
        loadTable();
    });
});

async function loadTable() {
    if (!currentTableId) return;

    // Show loading
    document.getElementById('tableResults').innerHTML = `
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading table data...</p>
            </div>
        </div>
    `;

    try {
        const response = await fetch(`/api/table/${currentTableId}`);
        const result = await response.json();

        if (result.error) {
            throw new Error(result.error);
        }

        displayTable(result);
    } catch (error) {
        document.getElementById('tableResults').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
            </div>
        `;
    }
}

function displayTable(table) {
    let tableHtml = '';
    if (table.data && table.data.length > 0) {
        tableHtml = `
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm report-table" id="tableData">
                    <thead class="table-dark">
                        <tr>
                            ${table.columns.map((col, idx) => `<th class="sortable-header" onclick="sortTable(${idx})" style="cursor: pointer;">
                                ${col.replace(/_/g, ' ').toUpperCase()}
                                <i class="bi bi-arrow-down-up" style="font-size: 0.8rem;"></i>
                            </th>`).join('')}
                        </tr>
                    </thead>
                    <tbody id="tableDataBody">
                        ${table.data.map(row => {
                            return `
                                <tr>
                                    ${table.columns.map(col => `<td>${row[col] ?? ''}</td>`).join('')}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    } else {
        tableHtml = '<div class="alert alert-warning">No data in this table</div>';
    }

    document.getElementById('tableResults').innerHTML = `
        <div class="card">
            <div class="card-header {% if environment == 'sample' %}bg-danger{% else %}bg-primary{% endif %} text-white">
                <h5 class="mb-0">${table.title}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">${table.description}</p>
                <p><strong>Total Rows:</strong> ${table.row_count.toLocaleString()}</p>
                ${tableHtml}
                <div class="mt-3">
                    <button class="btn btn-success btn-action" onclick="copyTableToClipboard('tableData')">
                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    `;
}

let sortDirections = {}; // Track sort direction for each column

function sortTable(columnIndex) {
    const table = document.getElementById('tableData');
    const tbody = document.getElementById('tableDataBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Toggle sort direction
    if (sortDirections[columnIndex] === undefined || sortDirections[columnIndex] === 'desc') {
        sortDirections[columnIndex] = 'asc';
    } else {
        sortDirections[columnIndex] = 'desc';
    }

    const isAscending = sortDirections[columnIndex] === 'asc';

    // Sort rows
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();

        // Try to parse as number (handle $ and , in numbers)
        const aNum = parseFloat(aValue.replace(/[$,%]/g, ''));
        const bNum = parseFloat(bValue.replace(/[$,%]/g, ''));

        // If both are numbers, sort numerically
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? aNum - bNum : bNum - aNum;
        }

        // Otherwise sort as strings
        return isAscending ?
            aValue.localeCompare(bValue) :
            bValue.localeCompare(aValue);
    });

    // Clear and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));

    // Update header icons
    const headers = table.querySelectorAll('th.sortable-header');
    headers.forEach((header, idx) => {
        const icon = header.querySelector('i');
        if (idx === columnIndex) {
            icon.className = isAscending ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        } else {
            icon.className = 'bi bi-arrow-down-up';
        }
    });
}
</script>
{% endblock %}
