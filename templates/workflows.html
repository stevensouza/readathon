{% extends "base.html" %}

{% block title %}Workflows - Read-a-Thon System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-diagram-3"></i> Workflows
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header card-header-blue" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseQD">
                <h5 class="mb-0">
                    QD: Daily Slide Update
                    <i class="bi bi-chevron-down float-end"></i>
                </h5>
            </div>
            <div class="card-body">
                <div class="collapse" id="collapseQD">
                    <p>Runs all slide deck reports in sequence ({{ qd_count }} reports):</p>
                    <ul class="small mb-3">
                        {% for report in qd_reports %}
                        <li>{{ report.name }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="mb-3">
                    <label for="qdDate" class="form-label">Date (for Prize Drawing)</label>
                    <select class="form-select" id="qdDate">
                        {% for date in dates %}
                        <option value="{{ date }}">{{ date }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button class="btn btn-success w-100" onclick="runWorkflow('qd')">
                    <i class="bi bi-play-fill"></i> Run Daily Workflow
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header card-header-blue" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseQC">
                <h5 class="mb-0">
                    QC: Cumulative Workflow
                    <i class="bi bi-chevron-down float-end"></i>
                </h5>
            </div>
            <div class="card-body">
                <div class="collapse" id="collapseQC">
                    <p>Runs all cumulative workflow reports ({{ qc_count }} reports):</p>
                    <ul class="small mb-3">
                        {% for report in qc_reports %}
                        <li>{{ report.name }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <button class="btn btn-info w-100" onclick="runWorkflow('qc')">
                    <i class="bi bi-play-fill"></i> Run Cumulative Workflow
                </button>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header card-header-blue" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseQF">
                <h5 class="mb-0">
                    QF: Final Prize Winners
                    <i class="bi bi-chevron-down float-end"></i>
                </h5>
            </div>
            <div class="card-body">
                <div class="collapse show" id="collapseQF">
                    <p>Runs all final prize winner reports ({{ qf_count }} reports):</p>
                    <ul class="small mb-3">
                        {% for report in qf_reports %}
                        <li>{{ report.name }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="mb-3">
                    <label for="qfDate" class="form-label">Date (for Q4 Daily Drawing)</label>
                    <select class="form-select" id="qfDate">
                        {% for date in dates %}
                        <option value="{{ date }}">{{ date }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button class="btn btn-primary w-100" onclick="runWorkflow('qf')">
                    <i class="bi bi-trophy-fill"></i> Run Final Prize Winners
                </button>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header card-header-blue" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseQA">
                <h5 class="mb-0">
                    QA: All Main Reports
                    <i class="bi bi-chevron-down float-end"></i>
                </h5>
            </div>
            <div class="card-body">
                <div class="collapse" id="collapseQA">
                    <p>Runs all main reports in sequence ({{ qa_count }} reports):</p>
                    <ul class="small mb-3">
                        {% for report in qa_reports %}
                        <li>{{ report.name }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="mb-3">
                    <label for="qaDate" class="form-label">Date (for Q2, Q4, Q7)</label>
                    <select class="form-select" id="qaDate">
                        {% for date in dates %}
                        <option value="{{ date }}">{{ date }}</option>
                        {% endfor %}
                    </select>
                </div>

                <button class="btn btn-warning w-100" onclick="runWorkflow('qa')">
                    <i class="bi bi-play-fill"></i> Run All Main Reports
                </button>
            </div>
        </div>

        <!-- Run Group Card -->
        <div class="card mt-3">
            <div class="card-header card-header-blue" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#collapseRunGroup">
                <h5 class="mb-0">
                    üéØ Run Group
                    <i class="bi bi-chevron-down float-end"></i>
                </h5>
            </div>
            <div class="card-body">
                <div class="collapse" id="collapseRunGroup">
                    <p>Select any group and run all items in that group:</p>
                    <ul class="small mb-3">
                        <li><strong>Prize Reports:</strong> All prize winner reports</li>
                        <li><strong>Update/Slides:</strong> Slide deck reports</li>
                        <li><strong>Export:</strong> Export/analysis reports</li>
                        <li><strong>Admin:</strong> Data integrity checks</li>
                        <li><strong>Tables:</strong> All database tables</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <label for="runGroupSelect" class="form-label">Select Group</label>
                    <select class="form-select" id="runGroupSelect">
                        <option value="prize">Prize Reports ({{ prize_count }} items)</option>
                        <option value="slides">Update Reports / Slides ({{ slides_count }} items)</option>
                        <option value="export">Export Reports ({{ export_count }} items)</option>
                        <option value="admin">Admin Reports ({{ admin_count }} items)</option>
                        <option value="table">Database Tables ({{ table_count }} items)</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="runGroupDate" class="form-label">Date (for date-dependent items)</label>
                    <select class="form-select" id="runGroupDate">
                        {% for date in dates %}
                        <option value="{{ date }}">{{ date }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Used for reports that require a date (Q2, Q4, Q7)</small>
                </div>

                <button class="btn btn-success w-100" onclick="runGroup()">
                    <i class="bi bi-play-circle"></i> Run All Items in Group
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div id="workflowResults">
            <div class="card">
                <div class="card-body text-center text-muted py-5">
                    <i class="bi bi-diagram-3" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select a workflow to run all reports in sequence</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Rotate chevron icons when collapsing/expanding
document.addEventListener('DOMContentLoaded', function() {
    const collapseElements = document.querySelectorAll('.collapse');
    collapseElements.forEach(function(collapseEl) {
        const chevron = collapseEl.closest('.card').querySelector('.bi-chevron-down');

        collapseEl.addEventListener('show.bs.collapse', function() {
            chevron.style.transform = 'rotate(180deg)';
            chevron.style.transition = 'transform 0.3s ease';
        });

        collapseEl.addEventListener('hide.bs.collapse', function() {
            chevron.style.transform = 'rotate(0deg)';
            chevron.style.transition = 'transform 0.3s ease';
        });

        // Set initial chevron state for expanded sections
        if (collapseEl.classList.contains('show')) {
            chevron.style.transform = 'rotate(180deg)';
        }
    });
});

async function runWorkflow(workflowId) {
    let url = `/api/workflow/${workflowId}`;

    if (workflowId === 'qd') {
        const date = document.getElementById('qdDate').value;
        if (date) url += `?date=${date}`;
    } else if (workflowId === 'qf') {
        const date = document.getElementById('qfDate').value;
        if (date) url += `?date=${date}`;
    } else if (workflowId === 'qa') {
        const date = document.getElementById('qaDate').value;
        if (date) url += `?date=${date}`;
    }

    // Show loading
    document.getElementById('workflowResults').innerHTML = `
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Running workflow...</p>
            </div>
        </div>
    `;

    try {
        const response = await fetch(url);
        const result = await response.json();

        if (result.error) {
            throw new Error(result.error);
        }

        displayWorkflowResults(result);
    } catch (error) {
        document.getElementById('workflowResults').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
            </div>
        `;
    }
}

function displayWorkflowResults(workflow) {
    let reportsHtml = '';

    workflow.reports.forEach((report, index) => {
        let winnersHtml = '';
        if (report.winners && report.winners.length > 0) {
            winnersHtml = `
                <div class="alert alert-warning mb-3">
                    <strong><i class="bi bi-trophy-fill"></i> Winner(s):</strong>
                    ${report.winners.map(w => w.class_name || w.team_name || w.student_name).join(', ')}
                </div>
            `;
        }

        let noteHtml = '';
        if (report.note) {
            noteHtml = `
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> ${report.note}
                </div>
            `;
        }

        let tableHtml = '';
        if (report.data && report.data.length > 0) {
            const winnerKeys = report.winners ? new Set(report.winners.map(w =>
                w.class_name || w.team_name || w.student_name
            )) : new Set();

            // Show all rows for Goal Getters (Q15) and per-grade prize reports (Q9, Q10, Q11), limit to 10 for others
            const showAllRows = report.title && (
                report.title.includes('Goal Getters') ||
                report.title.includes('Q9:') ||
                report.title.includes('Q10:') ||
                report.title.includes('Q11:')
            );
            const displayData = showAllRows ? report.data : report.data.slice(0, 10);
            const showingLimitNote = !showAllRows && report.data.length > 10;

            tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm" id="workflowTable${index}">
                        <thead class="table-dark">
                            <tr>
                                ${report.columns.map(col => `<th>${col.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${displayData.map(row => {
                                const isWinner = winnerKeys.has(row.class_name || row.team_name || row.student_name);
                                const rowClass = isWinner ? 'winner-row' : '';
                                return `
                                    <tr class="${rowClass}">
                                        ${report.columns.map(col => `<td>${row[col] ?? ''}</td>`).join('')}
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    ${showingLimitNote ? `<p class="text-muted text-center small">Showing first 10 of ${report.data.length} rows</p>` : ''}
                    ${showAllRows && report.data.length > 10 ? `<p class="text-muted text-center small">Showing all ${report.data.length} rows</p>` : ''}
                </div>
            `;
        }

        reportsHtml += `
            <div class="card mb-3">
                <div class="card-header card-header-blue">
                    <h6 class="mb-0">${index + 1}. ${report.title}</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted small">${report.description}</p>
                    ${winnersHtml}
                    ${noteHtml}
                    ${tableHtml}
                    <button class="btn btn-sm btn-success" onclick="copyTableToClipboard('workflowTable${index}')">
                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                    </button>
                </div>
            </div>
        `;
    });

    document.getElementById('workflowResults').innerHTML = `
        <div class="card">
            <div class="card-header card-header-blue">
                <h5 class="mb-0">${workflow.workflow_name}</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill"></i> Workflow completed successfully!
                    Generated ${workflow.reports.length} reports.
                </div>
                ${reportsHtml}
            </div>
        </div>
    `;
}

// Run Group function - runs all items in selected group
async function runGroup() {
    const selectedGroup = document.getElementById('runGroupSelect').value;
    const date = document.getElementById('runGroupDate').value;

    // Fetch items from the group dynamically using the API
    let groupData;
    try {
        const groupResponse = await fetch(`/api/group/${selectedGroup}/items`);
        groupData = await groupResponse.json();

        if (!groupData.success || !groupData.items || groupData.items.length === 0) {
            alert(`No items found in group: ${selectedGroup}`);
            return;
        }
    } catch (error) {
        alert(`Error fetching group data: ${error.message}`);
        return;
    }

    const items = groupData.items.map(item => item.id);

    // Show loading
    document.getElementById('workflowResults').innerHTML = `
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Running ${groupData.count} items from ${selectedGroup} group...</p>
                <small class="text-muted">This may take a moment</small>
            </div>
        </div>
    `;

    try {
        const results = [];
        let successCount = 0;
        let errorCount = 0;

        for (let i = 0; i < groupData.items.length; i++) {
            const item = groupData.items[i];
            const itemId = item.id;

            // Determine if this is a table or report based on groups
            // Reports take priority (they're executable), tables are just data views
            const isReport = item.groups && item.groups.includes('report');
            const isTable = item.groups && item.groups.includes('table') && !isReport;

            try {
                let url;
                if (isTable) {
                    url = `/api/table/${itemId}`;
                } else {
                    url = `/api/report/${itemId}?`;
                    if (date) url += `date=${date}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.error) {
                    errorCount++;
                    results.push({
                        id: itemId,
                        title: result.title || itemId,
                        error: result.error,
                        success: false
                    });
                } else {
                    successCount++;
                    results.push({
                        id: itemId,
                        title: result.title,
                        data: result.data,
                        columns: result.columns,
                        row_count: result.data ? result.data.length : 0,
                        success: true,
                        isTable: isTable
                    });
                }
            } catch (error) {
                errorCount++;
                results.push({
                    id: itemId,
                    title: itemId,
                    error: error.message,
                    success: false
                });
            }

            // Update progress
            document.getElementById('workflowResults').innerHTML = `
                <div class="card">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Running ${selectedGroup} group: ${i + 1}/${groupData.count} complete</p>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar" role="progressbar" style="width: ${((i + 1) / groupData.count) * 100}%">
                                ${Math.round(((i + 1) / groupData.count) * 100)}%
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Display results
        displayGroupResults(selectedGroup, results, successCount, errorCount);

    } catch (error) {
        document.getElementById('workflowResults').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error: ${error.message}
            </div>
        `;
    }
}

function displayGroupResults(groupName, results, successCount, errorCount) {
    let resultsHtml = '';

    results.forEach((result, index) => {
        if (!result.success) {
            resultsHtml += `
                <div class="card mb-3 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h6 class="mb-0">${index + 1}. ${result.title} ‚ùå</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-exclamation-triangle"></i> ${result.error}
                        </div>
                    </div>
                </div>
            `;
        } else {
            // Build table preview (show first 5 rows)
            let tablePreview = '';
            if (result.data && result.data.length > 0) {
                const previewRows = result.data.slice(0, 5);
                tablePreview = `
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    ${result.columns.map(col => `<th>${col.replace(/_/g, ' ').toUpperCase()}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${previewRows.map(row => `
                                    <tr>
                                        ${result.columns.map(col => `<td>${row[col] ?? ''}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${result.data.length > 5 ? `<small class="text-muted">Showing 5 of ${result.data.length} rows</small>` : ''}
                    </div>
                `;
            }

            resultsHtml += `
                <div class="card mb-3">
                    <div class="card-header card-header-blue">
                        <h6 class="mb-0">${index + 1}. ${result.title} ‚úÖ</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-2">
                            <i class="bi bi-table"></i> ${result.row_count} ${result.row_count === 1 ? 'row' : 'rows'}
                        </p>
                        ${tablePreview}
                    </div>
                </div>
            `;
        }
    });

    const statusClass = errorCount > 0 ? 'alert-warning' : 'alert-success';
    const statusIcon = errorCount > 0 ? 'bi-exclamation-triangle' : 'bi-check-circle-fill';

    document.getElementById('workflowResults').innerHTML = `
        <div class="card">
            <div class="card-header card-header-blue">
                <h5 class="mb-0">üéØ Run Group: ${groupName.charAt(0).toUpperCase() + groupName.slice(1)}</h5>
            </div>
            <div class="card-body">
                <div class="${statusClass}">
                    <i class="bi ${statusIcon}"></i>
                    Completed ${results.length} items: ${successCount} successful, ${errorCount} failed
                </div>
                <hr>
                ${resultsHtml}
            </div>
        </div>
    `;
}
</script>
{% endblock %}
